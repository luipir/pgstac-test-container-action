name: "Run pgstac and load STAC data"

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
      
      - name: Install pip
        run: |
          apt-get install -y python3-pip
          pip3 install --upgrade pip

      - name: Install pypgstac
        run: |
          pip3 install pypgstac[psycopg]==0.9.6

      - name: Install docker
        run: |
          apt-get install -y docker.io

      - name: Docker login
        if: env.DOCKERHUB_USERNAME && env.DOCKERHUB_TOKEN
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "${DOCKERHUB_TOKEN}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin

      - name: Pull pgstac Docker image
        run: docker pull ghcr.io/stac-utils/pgstac:v0.9.6

      - name: Start pgstac server
        run: |
          docker run -d \
            --name pgstac \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=postgis \
            -p ${{ vars.DB_PORT || 5439 }}:5432 \
            ghcr.io/stac-utils/pgstac:v0.9.6

      - name: Wait for pgstac to be ready
        run: |
          for i in {1..30}; do
            docker exec pgstac pg_isready -U postgres && break
            sleep 2
          done

      - name: Ensure load_stac_data.sh is executable
        run: chmod +x ./scripts/load_stac_data.sh

      - name: Load STAC data with pypgstac
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          ./scripts/load_stac_data.sh ${{ vars.STAC_DATA_DIR || 'testdata' }}